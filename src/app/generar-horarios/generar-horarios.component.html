<h2 class=" font-bold mb-6">GESTIÓN DE HORARIOS</h2>

<div class="w-full mb-8 font-montserrat">
  <!-- Accordion Header -->
  <div class="border border-gray-300 rounded-t-lg shadow-sm">
    <button (click)="toggleAccordion()"
      class="w-full flex justify-between items-center p-3 font-medium text-left bg-gray-50 hover:bg-gray-100 focus:outline-none"
      [attr.aria-expanded]="isAccordionOpen">
      <span class="text-sm font-semibold">Crear Horario</span>
      <svg class="w-4 h-4 transition-transform duration-200" [ngClass]="{'rotate-180': isAccordionOpen}"
        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </div>

  <!-- Accordion Content -->
  <div class="border-x border-b border-gray-300 rounded-b-lg overflow-hidden transition-all duration-300 ease-in-out"
    [ngClass]="{
    'max-h-0 opacity-0': !isAccordionOpen,
    'max-h-[1000px] opacity-100': isAccordionOpen
  }">
    <div class="p-4 bg-white">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Periodo -->
        <div>
          <label class="block font-medium mb-1 text-xs">Periodo:</label>
          <ng-select [items]="periodos" bindLabel="NOMBRE_PERIODO" bindValue="ID_PERIODO"
            [(ngModel)]="PeriodoSeleccionado" placeholder="Seleccionar periodo"
            (change)="onPeriodoChange(PeriodoSeleccionado)" [searchable]="true" [clearable]="false" [appendTo]="'body'"
            class="text-xs">
            <ng-template ng-label-tmp let-item="item">
              <div class="text-xs">{{ item ? item.NOMBRE_PERIODO : 'Seleccionar periodo' }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Tipo de Clase -->
        <div>
          <label class="block font-medium mb-1 text-xs">Tipo de Clase:</label>
          <ng-select [items]="tiposClase" bindLabel="nombre" bindValue="valor" [(ngModel)]="tipoClaseSeleccionado"
            placeholder="Seleccionar tipo" (change)="onTipoClaseChange(tipoClaseSeleccionado)" [searchable]="false"
            [clearable]="false" class="text-xs">
            <ng-template ng-label-tmp let-item="item">
              <div class="text-xs">{{ item ? item.nombre : 'Seleccionar tipo' }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Carrera (Solo para clases regulares) -->
        <div *ngIf="tipoClaseSeleccionado === 'regular'">
          <label class="block font-medium mb-1 text-xs">Carrera:</label>
          <ng-select [items]="carreras" bindLabel="NOMBRE_CARRERAS" bindValue="ID_CARRERAS"
            [(ngModel)]="CarreraSeleccionada" placeholder="Seleccionar carrera"
            (change)="onCarreraChange(CarreraSeleccionada)" [searchable]="true" [clearable]="false" [appendTo]="'body'"
            class="text-xs">
            <ng-template ng-label-tmp let-item="item">
              <div class="text-xs">{{ item ? item.NOMBRE_CARRERAS : 'Seleccionar carrera' }}</div>
            </ng-template>
          </ng-select>
        </div>



        <!-- Cursos Articulados (Solo para clases articuladas) -->
        <div *ngIf="tipoClaseSeleccionado === 'articulada'" class="md:col-span-2">
          <label class="block font-medium mb-1 text-xs">Cursos Articulados:</label>

          <!-- Lista de cursos articulados seleccionados -->
          <div *ngIf="cursosArticulados.length > 0" class="mb-3">
            <div class="text-xs font-medium mb-2">Cursos seleccionados:</div>
            <div class="space-y-2">
              <div *ngFor="let curso of cursosArticulados; let i = index"
                class="flex items-center justify-between bg-gray-100 p-2 rounded text-xs">
                <span>
                  <strong>Carrera:</strong> {{ getCarreraNombre(curso.ID_CARRERAS) }} -
                  <strong>Curso:</strong> {{ getCursoNombre(curso.ID_CURSOS) }}
                  <button (click)="eliminarCursoArticulado(i)" class="text-red-500 hover:text-red-700 ml-2">
                  <i class="fas fa-times"></i> Eliminar
                </button>
                </span>

              </div>
            </div>
          </div>

          <!-- Selector para agregar nuevos cursos articulados -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
            <div>
              <label class="block font-medium mb-1 text-xs">Carrera:</label>
              <ng-select [items]="carrerasArticuladas" bindLabel="NOMBRE_CARRERAS" bindValue="ID_CARRERAS"
                [(ngModel)]="nuevaCarreraArticulada" placeholder="Seleccionar carrera"
                (change)="onNuevaCarreraArticuladaChange(nuevaCarreraArticulada)" [searchable]="true" [clearable]="true"
                class="text-xs">
                <ng-template ng-label-tmp let-item="item">
                  <div class="text-xs">{{ item ? item.NOMBRE_CARRERAS : 'Seleccionar carrera' }}</div>
                </ng-template>
              </ng-select>
            </div>

            <div>
              <label class="block font-medium mb-1 text-xs">Curso:</label>
              <ng-select [items]="cursosDisponibles" bindLabel="NOMBRE_CURSOS" bindValue="ID_CURSOS"
                [(ngModel)]="nuevoCursoArticulado" placeholder="Seleccionar curso" [searchable]="true"
                [clearable]="true" [disabled]="!nuevaCarreraArticulada" class="text-xs">
                <ng-template ng-label-tmp let-item="item">
                  <div class="text-xs">{{ item ? item.NOMBRE_CURSOS : 'Seleccionar curso' }}</div>
                </ng-template>
              </ng-select>
            </div>

            <div>
              <button (click)="agregarCursoArticulado()" [disabled]="!nuevaCarreraArticulada || !nuevoCursoArticulado"
                class="bg-verde-claro text-white text-xs px-3 py-2 rounded hover:bg-green-600 transition-all duration-300 disabled:bg-gray-400">
                Agregar
              </button>
            </div>
          </div>
        </div>

        <!-- Docente - Asignatura - Nivel Combinado (Solo para clases regulares) -->
        <div *ngIf="tipoClaseSeleccionado === 'regular'" class="md:col-span-2">
          <label class="block font-medium mb-1 text-xs">Docente - Asignatura - Nivel:</label>
          <ng-select [items]="docenteAsignaturaNivel"
           [searchFn]="customSearchFn"
           bindValue="ID_COMBINACION"
           [(ngModel)]="CombinacionSeleccionada"
           placeholder="Seleccionar docente, asignatura y nivel"
           (change)="onCombinacionChange(CombinacionSeleccionada)"
           [searchable]="true"
           [clearable]="false"
           [appendTo]="'body'"
           [groupBy]="'DOCENTE'"
           [virtualScroll]="true"
           class="text-xs">

  <ng-template ng-label-tmp let-item="item">
    <div class="text-xs truncate">
      {{ item ? (item.DOCENTE | uppercase) + ' - ' + (item.ASIGNATURA | uppercase) + ' - ' + (item.NIVEL | uppercase) : 'Seleccionar docente, asignatura y nivel' }}
    </div>
  </ng-template>

  <ng-template ng-option-tmp let-item="item">
    <div class="text-xs py-1">
      <div><strong>Docente:</strong> {{ item.DOCENTE | uppercase }}</div>
      <div><strong>Asignatura:</strong> {{ item.ASIGNATURA | uppercase }}</div>
      <div><strong>Nivel:</strong> {{ item.NIVEL | uppercase }}</div>
    </div>
  </ng-template>

  <ng-template ng-header-tmp>
    <div class="text-xs font-semibold p-1">Seleccionar docente, asignatura y nivel</div>
  </ng-template>

  <ng-template ng-notfound-tmp>
    <div class="text-xs p-2">No se encontraron resultados</div>
  </ng-template>
</ng-select>
        </div>

        <!-- Docente (Solo para clases articuladas) -->
        <div *ngIf="tipoClaseSeleccionado === 'articulada'" class="md:col-span-2">
          <label class="block font-medium mb-1 text-xs">Docente - Asignatura:</label>
          <ng-select [items]="docentes"
           [(ngModel)]="DocenteAsignaturaSeleccionada"
           placeholder="Seleccionar docente y asignatura"
           (change)="onDocenteAsignaturaChange(DocenteAsignaturaSeleccionada)"
           [searchable]="true"
           [clearable]="false"
           [appendTo]="'body'"
           [groupBy]="'DOCENTE'"
           [virtualScroll]="true"
           bindLabel="SEARCH_TEXT"
           [searchFn]="customSearchFn"
           class="text-xs">

  <!-- Etiqueta cuando está seleccionado -->
  <ng-template ng-label-tmp let-item="item">
    <div class="text-xs truncate">
      {{ item ? (item.DOCENTE | uppercase) + ' - ' + (item.ASIGNATURA | uppercase) : 'Seleccionar docente y asignatura' }}
    </div>
  </ng-template>

  <!-- Opciones desplegables -->
  <ng-template ng-option-tmp let-item="item">
    <div class="text-xs py-1">
      <div><strong>Docente:</strong> {{ item.DOCENTE | uppercase }}</div>
      <div><strong>Asignatura:</strong> {{ item.ASIGNATURA | uppercase }}</div>
    </div>
  </ng-template>

  <!-- Cabecera de resultados -->
  <ng-template ng-header-tmp>
    <div class="text-xs font-semibold p-1">Seleccionar docente y asignatura</div>
  </ng-template>

  <!-- Si no hay resultados -->
  <ng-template ng-notfound-tmp>
    <div class="text-xs p-2">No se encontraron resultados</div>
  </ng-template>
</ng-select>
        </div>


        <!-- Aula -->
        <div>
          <label class="block font-medium mb-1 text-xs">Aula:</label>
          <ng-select [items]="aulas" bindLabel="NOMBRE_AULA" bindValue="ID_AULA" [(ngModel)]="AulaSeleccionada"
            placeholder="Seleccionar aula" [searchable]="true" [clearable]="false" class="text-xs">
            <ng-template ng-label-tmp let-item="item">
              <div class="text-xs">{{ item ? item.NOMBRE_AULA : 'Seleccionar aula' }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Día -->
        <div>
          <label class="block font-medium mb-1 text-xs">Día:</label>
          <ng-select [items]="dias" bindLabel="NOMBRE_DIA" bindValue="ID_DIA" [(ngModel)]="DiaSeleccionado"
            placeholder="Seleccionar día" [searchable]="true" [clearable]="false" class="text-xs">
            <ng-template ng-label-tmp let-item="item">
              <div class="text-xs">{{ item ? item.NOMBRE_DIA : 'Seleccionar día' }}</div>
            </ng-template>
          </ng-select>
        </div>

        <!-- Horario -->
        <div class="md:col-span-2 flex flex-wrap items-end gap-3">
          <div>
            <label for="horaInicio" class="block text-xs font-medium mb-1">Hora inicio:</label>
            <input type="time" id="horaInicio" name="horaInicio" [(ngModel)]="horaInicio"
              class="p-1 border border-gray-300 rounded text-xs w-24">
          </div>

          <div>
            <label for="horaFin" class="block text-xs font-medium mb-1">Hora fin:</label>
            <input type="time" id="horaFin" name="horaFin" [(ngModel)]="horaFin"
              class="p-1 border border-gray-300 rounded text-xs w-24">
          </div>

          <div>
            <label for="fechaInicio" class="block text-xs font-medium mb-1">Fecha inicio:</label>
            <input type="date" id="fechaInicio" name="fechaInicio" [(ngModel)]="fechaInicio"
              class="p-1 border border-gray-300 rounded text-xs w-24">
          </div>

          <div>
            <label for="fechaFin" class="block text-xs font-medium mb-1">Fecha fin:</label>
            <input type="date" id="fechaFin" name="fechaFin" [(ngModel)]="fechaFin"
              class="p-1 border border-gray-300 rounded text-xs w-24">
          </div>

          <div>
            <button (click)="asignarHorario()"
              class="bg-azul-botones text-white text-xs px-2 py-1 rounded hover:bg-blue-700 transition-all duration-300 disabled:bg-gray-400">
              Aceptar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calendario de horarios con FullCalendar -->
<div class="mt-8">
  <h2 class=" font-bold mb-4">Horario Semanal</h2>

  <!-- Contenedor del calendario -->
  <div class="border border-gray-300 rounded shadow-sm calendar-container"
    *ngIf="horariosFiltrados && horariosFiltrados.length > 0">
    <full-calendar #calendar [options]="calendarOptions"></full-calendar>
  </div>

  <!-- Leyenda de materias y sus colores -->
  <div class="mt-6 legend-container" *ngIf="materiasUnicas && materiasUnicas.length > 0">
    <h3 class="text-lg font-bold mb-2">Materias</h3>
    <div class="flex flex-wrap gap-2">
      <div *ngFor="let materia of materiasUnicas" class="flex items-center px-3 py-1 rounded materia-item"
        [ngStyle]="{'background-color': materia.color}">
        <span class="mr-2 w-3 h-3 rounded-full" [ngStyle]="{'background-color': materia.color}"></span>
        <span>{{ materia.nombre }}</span>
      </div>
    </div>
  </div>

  <!-- Mensaje cuando no hay horarios -->
  <div *ngIf="!horariosFiltrados || horariosFiltrados.length === 0" class="mt-4 p-4 bg-gray-100 rounded-lg text-center">
    <p>No hay clases asignadas para el periodo seleccionado. Agrega clases para visualizar el horario.</p>
  </div>
</div>

<!-- Modal de Detalle de Horario -->
<div *ngIf="modalVisible"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
  <div class="relative bg-white rounded-lg shadow-lg max-w-md w-full mx-4">
    <!-- Encabezado del modal -->
    <div class="flex justify-between items-center border-b p-4">
      <h3 class="text-xl font-bold text-gray-800">
        <span *ngIf="!modoEdicion">Detalle del Horario</span>
        <span *ngIf="modoEdicion">Editar Horario</span>
      </h3>
      <button (click)="cerrarModal()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Cuerpo del modal -->
    <div class="p-4">
      <!-- Mensaje de éxito o error -->
      <div *ngIf="mensajeModal"
        [ngClass]="{'bg-green-100 text-green-700': tipoMensajeModal === 'success', 'bg-red-100 text-red-700': tipoMensajeModal === 'error'}"
        class="p-3 rounded mb-4">
        {{ mensajeModal }}
      </div>

      <!-- Detalles del horario (modo visualización) -->
      <div *ngIf="!modoEdicion && horarioSeleccionado">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <p class="text-gray-600 text-sm">Docente:</p>
            <p class="font-semibold">{{ horarioSeleccionado.docente.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Asignatura:</p>
            <p class="font-semibold">{{ horarioSeleccionado.asignatura.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Carrera:</p>
            <p class="font-semibold">{{ horarioSeleccionado.carrera.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Nivel:</p>
            <p class="font-semibold">{{ horarioSeleccionado.curso.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Aula:</p>
            <p class="font-semibold">{{ horarioSeleccionado.aula.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Día:</p>
            <p class="font-semibold">{{ horarioSeleccionado.dia.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Hora inicio:</p>
            <p class="font-semibold">{{ formatHora(horarioSeleccionado.horaInicio) }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Hora fin:</p>
            <p class="font-semibold">{{ formatHora(horarioSeleccionado.horaFin) }}</p>
          </div>
        </div>
      </div>

      <!-- Formulario de edición -->
      <div *ngIf="modoEdicion && horarioSeleccionado" class="space-y-4">
        <!-- Campos no editables (solo informativos) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <p class="text-gray-600 text-sm">Docente:</p>
            <p class="font-semibold">{{ horarioSeleccionado.docente.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Asignatura:</p>
            <p class="font-semibold">{{ horarioSeleccionado.asignatura.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Carrera:</p>
            <p class="font-semibold">{{ horarioSeleccionado.carrera.nombre }}</p>
          </div>
          <div>
            <p class="text-gray-600 text-sm">Nivel:</p>
            <p class="font-semibold">{{ horarioSeleccionado.curso.nombre }}</p>
          </div>
        </div>

        <!-- Campos editables -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Docente -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Docente:</label>
            <ng-select [items]="docentesUnicos" bindLabel="DOCENTE" bindValue="ID_DOCENTE"
              [(ngModel)]="editDocenteSeleccionado" name="editDocente"
              placeholder="Seleccionar docente" [searchable]="true" [clearable]="false" class="text-sm">
              <ng-template ng-label-tmp let-item="item">
                <div class="text-xs">{{ item ? item.DOCENTE : 'Seleccionar docente' }}</div>
              </ng-template>
              <ng-template ng-option-tmp let-item="item">
                <div class="text-xs">{{ item.DOCENTE }}</div>
              </ng-template>
            </ng-select>
          </div>
          <!-- Día -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Día:</label>
            <select [(ngModel)]="editDiaSeleccionado" name="editDia"
              class="w-full p-2 border border-gray-300 rounded text-sm">
              <option *ngFor="let dia of dias" [value]="dia.ID_DIA">{{ dia.NOMBRE_DIA }}</option>
            </select>
          </div>

          <!-- Aula -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Aula:</label>
            <select [(ngModel)]="editAulaSeleccionada" name="editAula"
              class="w-full p-2 border border-gray-300 rounded text-sm">
              <option *ngFor="let aula of aulas" [value]="aula.ID_AULA">{{ aula.NOMBRE_AULA }}</option>
            </select>
          </div>

          <!-- Hora Inicio -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hora inicio:</label>
            <input type="time" [(ngModel)]="editHoraInicio" name="editHoraInicio"
              class="w-full p-2 border border-gray-300 rounded text-sm">
          </div>

          <!-- Hora Fin -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hora fin:</label>
            <input type="time" [(ngModel)]="editHoraFin" name="editHoraFin"
              class="w-full p-2 border border-gray-300 rounded text-sm">
          </div>

          <!-- Fecha Inicio -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha inicio:</label>
            <input type="date" [(ngModel)]="editFechaInicio" name="editFechaInicio"
              class="w-full p-2 border border-gray-300 rounded text-sm">
          </div>

          <!-- Fecha Fin -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha fin:</label>
            <input type="date" [(ngModel)]="editFechaFin" name="editFechaFin"
              class="w-full p-2 border border-gray-300 rounded text-sm">
          </div>
        </div>
      </div>
    </div>

    <!-- Botones del modal -->
    <div class="border-t p-4 flex justify-end space-x-3">
      <button *ngIf="!modoEdicion" (click)="eliminarHorario()"
        class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700">
        Eliminar
      </button>
      <button *ngIf="!modoEdicion" (click)="activarModoEdicion()"
        class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">
        Editar
      </button>
      <button *ngIf="modoEdicion" (click)="cancelarEdicion()"
        class="bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm hover:bg-gray-400">
        Cancelar
      </button>
      <button *ngIf="modoEdicion" (click)="guardarCambiosHorario()"
        class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">
        Guardar
      </button>
    </div>
  </div>
</div>
